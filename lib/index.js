'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();Object.defineProperty(exports,'__esModule',{value:!0});exports.evaluate=evaluate,exports.getFieldNamesFromExpression=getFieldNamesFromExpression,exports.populatePreparedConditions=populatePreparedConditions;var _lodash=require('lodash'),_lodash2=_interopRequireDefault(_lodash);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var Stack=function(){function a(){_classCallCheck(this,a),this.top=-1,this.items=[]}return _createClass(a,[{key:'push',value:function push(a){var b=this.top;this.items[b+1]=a,this.top=b+1}},{key:'pop',value:function pop(){var a=this.top,b=this.items[a];return this.top=a-1,b}},{key:'peek',value:function peek(){return this.items[this.top]}},{key:'empty',value:function empty(){return-1===this.top}}]),a}(),precedence={"(":8,")":8,"!":7,"^":6,"*":5,"/":5,"+":4,"-":4,contains:3,hasLength:3,">":3,"<":3,"==":2,"!=":2,"&&":1,"||":1};function hasPrecedence(a,b){return'('!==b&&')'!==b&&precedence[b]>=precedence[a]}function applyOp(c,d,e){switch(c){case'+':return e+d;case'-':return e-d;case'*':return e*d;case'/':return e/d;case'==':return e===d;case'!=':return e!==d;case'&&':return e&&d;case'||':return e||d;case'>':return e>d;case'<':return e<d;case'!':return!d;case'contains':try{var a=JSON.parse(d);return _lodash2.default.some(e||[],a)}catch(a){return-1<(e||[]).indexOf(d)}case'hasLength':return(e||[]).length===d;}return 0}var allowedOps=['+','-','*','/','==','!=','&&','||','>','<','contains','hasLength','!'],oneParamOps=['!'],opsSplitters=['\\s+','\\(','\\)','!(?!=)'],splitRegexp=new RegExp('('+opsSplitters.join('|')+')');function evaluate(a,b){for(var c=a.split(splitRegexp).map(function(a){return a.trim()}).filter(function(a){return''!==a}),d=new Stack,e=new Stack,f=[],g=0;g<c.length;g++)if('('===c[g])e.push(c[g]),f.push(g);else if(')'===c[g]){for(;'('!==e.peek()&&!e.empty();){var h=e.pop();-1===oneParamOps.indexOf(h)?d.push(applyOp(h,d.pop(),d.pop())):d.push(applyOp(h,d.pop()))}e.empty()?f.push(g):(f.pop(),e.pop())}else if(-1<allowedOps.indexOf(c[g])){for(;!e.empty()&&hasPrecedence(c[g],e.peek());){var i=e.pop();-1===oneParamOps.indexOf(i)?d.push(applyOp(i,d.pop(),d.pop())):d.push(applyOp(i,d.pop()))}e.push(c[g])}else if(c[g]in b)d.push(_lodash2.default.get(b,c[g]));else if(!isNaN(c[g]))d.push(parseInt(c[g]));else{var j=c[g].replace(/'/g,'');j='true'===j||'false'!==j&&j,d.push(j)}if(0!==f.length)throw new Error('Parens with the following token indexes are unbalanced: '+f);for(;!e.empty();){var k=e.pop();-1===oneParamOps.indexOf(k)?d.push(applyOp(k,d.pop(),d.pop())):d.push(applyOp(k,d.pop()))}return d.pop()}function getFieldNamesFromExpression(a){var b=/([a-z]+[a-z0-9]*(?:\.[a-z]+[a-z0-9]*)+)/ig,c=void 0,d=[];do c=b.exec(a),c&&d.push(c[1]);while(c);return d}function populatePreparedConditions(a,b){return b&&_lodash2.default.forEach(b,function(b,c){var d=new RegExp('('+'^|\\s|\\(|!'+')'+c+'(?='+'$|\\s|\\)'+')','g');a=a.replace(d,'$1'+b)}),a}